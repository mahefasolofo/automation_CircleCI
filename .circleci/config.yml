version: 2.1

jobs:
  verification:
    docker:
      - image: cypress/base
    steps:
      - checkout
      - run: npm install
      - run:
          name: verification lint
          command: npm run lint
  test:
    docker:
      - image: cypress/base
    steps:
      - checkout
      - run: npm install
      - run:
          name: Run Cypress tests
          command: npx cypress run
  build_artifact:
    docker:
      - image: circleci/node:14.17.3-browsers
    steps:
      - checkout
      - run: npm install
      - run:
          name: Concatenate JSON reports
          command: |
            npm install -g mochawesome-merge
            mochawesome-merge root/project/cypress/results/*.json > merged-report.json
        # Génération du rapport HTML
      - run:
          name: Generate HTML report
          command: |
            npm install -g mochawesome-report-generator
            marge merged-report.json   

  # Configuration des artifacts
  artifacts:
    docker:
      - image: circleci/node:14.17.3-browsers
    # Définition des fichiers à archiver
    paths:
      - merged-report.json
      - mochawesome.html
workflows:
  verification_test:
    jobs:
      - verification
      - test:
          requires:
            - verification
      - build_artifact:
          requires:
            - test
      - artifacts:
          requires:
            - build_artifact